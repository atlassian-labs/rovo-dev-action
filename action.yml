name: "Rovo Dev Action"
description: "Run Rovo Dev (Atlassian's developer AI agent) in GitHub Actions"
branding:
  icon: "cpu"
  color: "green"

inputs:
  prompt:
    description: "The prompt/instructions to send to Rovo Dev CLI"
    required: true
  atlassian_email:
    description: "Atlassian account email for authentication"
    required: true
  atlassian_token:
    description: "Rovo Dev scoped API token for authentication"
    required: true
  working_directory:
    description: "Working directory for Rovo Dev CLI execution"
    required: false
    default: "."
  config_file:
    description: "Path to a custom Rovo Dev configuration file (YAML). If provided, this will be passed to the CLI via --config-file."
    required: false
    default: ""
  # PR creation inputs
  github_token:
    description: "GitHub token for PR creation and repository operations. Required if create_pr is true."
    required: false
    default: ""
  create_pr:
    description: "Whether to automatically create a PR with changes made by Rovo Dev"
    required: false
    default: "false"
  pr_title:
    description: "Title for the PR (used if create_pr is true)"
    required: false
    default: "Changes by Rovo Dev"
  pr_body:
    description: "Body/description for the PR (used if create_pr is true)"
    required: false
    default: "Automated changes by Rovo Dev"
  pr_base_branch:
    description: "Base branch for PR creation. Defaults to the current branch if not specified."
    required: false
    default: ""
  branch_prefix:
    description: "Prefix for auto-created branches"
    required: false
    default: "rovodev/"

outputs:
  exit_code:
    description: "Exit code from Rovo Dev CLI execution"
    value: ${{ steps.run-rovo-dev.outputs.exit_code }}
  pr_created:
    description: "Whether a PR was created (true/false)"
    value: ${{ steps.create-pr.outputs.pr_created }}
  pr_url:
    description: "URL of the created PR (if pr_created is true)"
    value: ${{ steps.create-pr.outputs.pr_url }}
  branch_name:
    description: "Name of the branch created for the PR"
    value: ${{ steps.branch-setup.outputs.branch_name }}

runs:
  using: "composite"
  steps:
    - name: Install Atlassian CLI
      shell: bash
      run: |
        echo "Installing Atlassian CLI..."

        # Detect OS and architecture
        OS=$(uname -s | tr '[:upper:]' '[:lower:]')
        ARCH=$(uname -m)

        # Map architecture names
        case "$ARCH" in
          x86_64)
            ARCH="amd64"
            ;;
          aarch64|arm64)
            ARCH="arm64"
            ;;
          *)
            echo "::error::Unsupported architecture: $ARCH"
            exit 1
            ;;
        esac

        # Build download URL based on OS
        case "$OS" in
          darwin)
            DOWNLOAD_URL="https://acli.atlassian.com/darwin/latest/acli_darwin_${ARCH}/acli"
            BINARY_NAME="acli"
            ;;
          linux)
            DOWNLOAD_URL="https://acli.atlassian.com/linux/latest/acli_linux_${ARCH}/acli"
            BINARY_NAME="acli"
            ;;
          mingw*|msys*|cygwin*)
            DOWNLOAD_URL="https://acli.atlassian.com/windows/latest/acli_windows_${ARCH}/acli.exe"
            BINARY_NAME="acli.exe"
            ;;
          *)
            echo "::error::Unsupported OS: $OS"
            exit 1
            ;;
        esac

        echo "Downloading from: $DOWNLOAD_URL"

        # Download and install
        curl -fsSL "$DOWNLOAD_URL" -o /usr/local/bin/$BINARY_NAME
        chmod +x /usr/local/bin/$BINARY_NAME

        echo "Atlassian CLI installed successfully"
        acli --version

    - name: Authenticate with Rovo Dev
      shell: bash
      env:
        ATLASSIAN_EMAIL: ${{ inputs.atlassian_email }}
        ATLASSIAN_TOKEN: ${{ inputs.atlassian_token }}
      run: |
        echo "Authenticating with Rovo Dev..."
        echo "$ATLASSIAN_TOKEN" | acli rovodev auth login --email "$ATLASSIAN_EMAIL" --token
        echo "Authentication successful"

    - name: Setup Git Identity
      if: ${{ inputs.create_pr == 'true' }}
      shell: bash
      run: |
        git config --global user.name "Rovo Dev"
        git config --global user.email "rovodev[bot]@users.noreply.github.com"

    - name: Create Feature Branch
      if: ${{ inputs.create_pr == 'true' }}
      id: branch-setup
      shell: bash
      run: |
        # Determine base branch: use input if provided, otherwise detect current branch
        BASE_BRANCH="${{ inputs.pr_base_branch }}"
        if [ -z "$BASE_BRANCH" ]; then
          BASE_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "No base branch specified, using current branch: $BASE_BRANCH"
        fi

        "${{ github.action_path }}/scripts/branch-setup.sh" \
          "run" \
          "${{ github.run_number }}" \
          "$BASE_BRANCH" \
          "${{ inputs.branch_prefix }}"

    - name: Run Rovo Dev CLI
      id: run-rovo-dev
      shell: bash
      env:
        PROMPT: ${{ inputs.prompt }}
        WORKING_DIR: ${{ inputs.working_directory }}
        CONFIG_FILE: ${{ inputs.config_file }}
        ROVODEV_BETA: false
      run: |
        echo "Running Rovo Dev CLI..."
        cd "$WORKING_DIR"

        # Build command with optional config file
        CMD="acli rovodev run --yolo"
        if [ -n "$CONFIG_FILE" ]; then
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "::error::Config file not found: $CONFIG_FILE"
            exit 1
          fi
          CMD="$CMD --config-file \"$CONFIG_FILE\""
        fi

        # Run Rovo Dev with the provided prompt
        set +e
        eval "$CMD \"$PROMPT\""
        EXIT_CODE=$?
        set -e

        echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

        if [ $EXIT_CODE -ne 0 ]; then
          echo "::warning::Rovo Dev CLI exited with code $EXIT_CODE"
        fi

        exit $EXIT_CODE

    - name: Create Pull Request
      if: ${{ inputs.create_pr == 'true' && steps.run-rovo-dev.outputs.exit_code == '0' }}
      id: create-pr
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
      run: |
        # Use the same base branch that was used for branch setup
        BASE_BRANCH="${{ inputs.pr_base_branch }}"
        if [ -z "$BASE_BRANCH" ]; then
          BASE_BRANCH="${{ steps.branch-setup.outputs.base_branch }}"
        fi

        "${{ github.action_path }}/scripts/create-pr.sh" \
          "${{ steps.branch-setup.outputs.branch_name }}" \
          "$BASE_BRANCH" \
          "${{ inputs.pr_title }}" \
          "${{ inputs.pr_body }}"
